<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Kitchen Board</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .order-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .status-Pending { background-color: #fff3cd; } 
        .status-Cooking { background-color: #cff4fc; } 
        .status-Ready { background-color: #d1e7dd; }   
        button { cursor: pointer; padding: 5px 10px; margin-left: 5px; }
        
        /* New Styles for Login */
        #login-section { background: #eee; padding: 15px; margin-bottom: 20px; border-radius: 8px; display: none; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>üçï Live Kitchen Monitor</h1>

    <div id="login-section" style="display: block;">
        <h3>üë®‚Äçüç≥ Kitchen Staff Login</h3>
        <input type="password" id="password-input" placeholder="Enter Password (chef123)">
        <button onclick="login()">Login</button>
        <p id="login-error" style="color: red;"></p>
    </div>
    
    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h3>New Order</h3>
        <input type="text" id="customer" placeholder="Customer Name">
        <input type="text" id="item" placeholder="Item (e.g. Pizza)">
        <button onclick="placeOrder()">Place Order</button>
    </div>

    <div id="orders-container"></div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // üëá UPDATE THIS WITH YOUR RENDER URL üëá
        const API_URL = 'https://live-kitchen.onrender.com'; 
        
        const socket = io(API_URL);
        let authToken = localStorage.getItem('kitchen_token'); // Check if already logged in

        // UI Logic to hide/show login box
        const loginSection = document.getElementById('login-section');
        if(authToken) loginSection.style.display = 'none';

        async function login() {
            const password = document.getElementById('password-input').value;
            
            const res = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });

            const data = await res.json();
            
            if (data.success) {
                authToken = data.token;
                localStorage.setItem('kitchen_token', authToken); // Save badge to browser memory
                loginSection.style.display = 'none';
                alert("Login Successful! You can now update orders.");
            } else {
                document.getElementById('login-error').innerText = "Wrong Password!";
            }
        }

        async function loadOrders() {
            const res = await fetch(`${API_URL}/orders`);
            const orders = await res.json();
            document.getElementById('orders-container').innerHTML = ''; 
            orders.forEach(displayOrder);
        }

        function displayOrder(order) {
            const container = document.getElementById('orders-container');
            const existing = document.getElementById(order._id);
            
            const html = `
                <div>
                    <strong>${order.item}</strong> for ${order.customerName}
                    <br><small>${order.status}</small>
                </div>
                <div>${getButtons(order)}</div>
            `;

            if (existing) {
                existing.className = `order-card status-${order.status}`;
                existing.innerHTML = html;
            } else {
                const div = document.createElement('div');
                div.id = order._id;
                div.className = `order-card status-${order.status}`;
                div.innerHTML = html;
                container.prepend(div);
            }
        }
        async function deleteOrder(id) {
            if (!authToken) return alert("Only the Chef can delete orders!");
            
            if(!confirm("Remove this order permanently?")) return; // Safety confirmation

            await fetch(`${API_URL}/orders/${id}`, {
                method: 'DELETE',
                headers: { 
                    'Authorization': authToken 
                }
            });
            // We don't remove the HTML here. We wait for the socket event below.
        }

        function getButtons(order) {
            if (order.status === 'Pending') return `<button onclick="updateStatus('${order._id}', 'Cooking')">Cook</button>`;
            if (order.status === 'Cooking') return `<button onclick="updateStatus('${order._id}', 'Ready')">Done</button>`;
            
            // If Ready (Green), show the Delete button
            if (order.status === 'Ready') return `<button onclick="deleteOrder('${order._id}')" style="background: #ffcccc; color: red;">‚ùå</button>`;
            
            return '';
        }

        async function placeOrder() {
            const customer = document.getElementById('customer').value;
            const item = document.getElementById('item').value;
            if(!customer || !item) return;

            await fetch(`${API_URL}/orders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customerName: customer, item })
            });
            document.getElementById('customer').value = '';
            document.getElementById('item').value = '';
        }

        // --- SECURE UPDATE FUNCTION ---
        async function updateStatus(id, newStatus) {
            if (!authToken) return alert("‚ö†Ô∏è Access Denied: You must login as Chef first!");

            const res = await fetch(`${API_URL}/orders/${id}`, {
                method: 'PATCH',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': authToken // üëà SENDING THE KEY HERE
                },
                body: JSON.stringify({ status: newStatus })
            });

            if (res.status === 401 || res.status === 403) {
                alert("Session expired. Please login again.");
                localStorage.removeItem('kitchen_token');
                location.reload();
            }
        }

        socket.on('order_updated', displayOrder);
        // Remove the card from the screen when server says so
        socket.on('order_deleted', (id) => {
            console.log("üöÄ SOCKET RECEIVED DELETE COMMAND FOR:", id); // <--- This proves the code is new
            const element = document.getElementById(id);
            if (element) {
                element.remove(); 
            }
        });
        loadOrders();
    </script>
</body>
</html>